export const Tokens = ({ env, id }) => {
  const key = `chains-${env}`;

  if (typeof window === "undefined") {
    return null;
  }
  if (typeof document === "undefined") {
    return null;
  }

  if (!window[key]) {
    window[key] = {
      fetching: false,
      data: null,
      observer: null
    };
  }

  if (!window[key].fetching) {
    const appendChains = (data) => {
      const rootElement = document.getElementById(id);
      if (!rootElement) {
        return;
      }
      const rows = data
        .slice()
        .sort((a, b) => a.chainId - b.chainId)
        .map((token) => {
          const price = token.priceUSD ? `$${parseFloat(token.priceUSD).toFixed(2)}` : "N/A";
          
          return `<tr key=${token.chainId}-${token.address}>
          <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">${token.chainId}</td>
          <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; font-weight: 600;">${token.symbol}</td>
          <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; font-family: monospace; font-size: 12px; word-break: break-all;">${token.address}</td>
          <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: right; color: #16a34a; font-weight: 500;">${price}</td>
        </tr>`;
        });

      rootElement.innerHTML = `<div id="${id}-marker"></div>${rows.join("")}`;
      if (!window[key].observer) {
        let observer = new MutationObserver(function(mutations) {
          if (!document.getElementById(`${id}-marker`)) {
            appendChains(data)
          }
        });
        observer.observe(document.body, {childList: true, subtree: true});
        window[key].observer = observer
      }
    };

    const fetchChains = async () => {
      try {
        if (window[key].fetching) return;
        window[key].fetching = true;
        window[key].data = null;
        const response = await fetch("https://li.quest/v1/tokens?chainTypes=EVM");
        const result = await response.json();
        const tokens = Object.values(result.tokens).flat();
        window[key].fetching = false;
        window[key].data = tokens;
        appendChains(tokens);
      } catch (e) {
        window[key].fetching = false;
        window[key].data = false;
      }
    };

    if (window[key].data) {
      appendChains(window[key].data);
    } else {
      fetchChains();
    }
  }

  return (
    <table
      style={{ 
        width: "100%", 
        borderCollapse: "collapse",
        tableLayout: "fixed",
        maxWidth: "100%"
      }}
      className="anypay-table"
    >
      <thead
        style={{
          borderBottom: "2px solid rgb(227 226 230)",
          backgroundColor: "#f9fafb"
        }}
      >
        <tr style={{ textAlign: "left" }}>
          <th style={{ padding: "16px 8px", fontWeight: "600", fontSize: "14px", width: "12%", textAlign: "center" }}>Chain ID</th>
          <th style={{ padding: "16px 8px", fontWeight: "600", fontSize: "14px", width: "18%" }}>Token</th>
          <th style={{ padding: "16px 8px", fontWeight: "600", fontSize: "14px", width: "50%" }}>Address</th>
          <th style={{ padding: "16px 8px", fontWeight: "600", fontSize: "14px", width: "20%", textAlign: "right" }}>Price (USD)</th>
        </tr>
      </thead>
      <tbody id={id}></tbody>
    </table>
  );
};